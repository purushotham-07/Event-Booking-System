<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist | Event Booking</title>
    <link rel="stylesheet" href="/static/wishlist.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

    <div class="wishlist-container">
        <h2>üéüÔ∏è Your Wishlist</h2>

        {% if wishlist_items %}
        <div class="wishlist-items">
            {% for item in wishlist_items %}
            <div class="wishlist-item">
                <img src="{{ item.event.image.url }}" alt="{{ item.event.name }}">
                <div class="event-details">
                    <h3>{{ item.event.name }}</h3>
                    <p class="price">‚Çπ{{ item.event.ticket_price }}</p>
                </div>
                <button class="remove-btn" onclick="removeItem('{{ item.id }}')">üóëÔ∏è Remove</button>
            </div>
            {% endfor %}
        </div>

        <div class="total-section">
            <h3>Total: ‚Çπ<span id="total-price">{{ total_price }}</span></h3>
            <button class="book-all-btn" onclick="bookAll()">üìÖ Book All</button>
        </div>

        {% else %}
        <div class="empty-wishlist">
            <img src="/static/images/empty.png" alt="Empty Wishlist">
            <p>Your wishlist is empty. Add events to book them later!</p>
        </div>
        {% endif %}
    </div>

    <script>
        function removeItem(itemId) {
            fetch(`/remove-from-wishlist/${itemId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(), 
                    "Content-Type": "application/json"
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Failed to remove item.");
                }
            });
        }

        function getCSRFToken() {
            let cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                let [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return value;
            }
            return '';
        }

        function bookAll() {
            fetch("/create-order/", {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken() }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    var options = {
                        "key": "{{ razorpay_key }}",
                        "amount": data.amount,
                        "currency": "INR",
                        "name": "Event Booking",
                        "description": "Booking for selected events",
                        "order_id": data.order_id,
                        "handler": function (response) {
                            fetch("/verify-payment/", {
                                method: "POST",
                                headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/json" },
                                body: JSON.stringify(response)
                            })
                            .then(res => res.json())
                            .then(result => {
                                if (result.status === "success") {
                                    window.location.href = "/payment-success/";
                                } else {
                                    alert("Payment verification failed!");
                                }
                            });
                        },
                        "prefill": {
                            "email": "{{ request.user.email }}"
                        },
                        "theme": { "color": "#28a745" }
                    };
    
                    var rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    alert("Error: " + data.message);
                }
            });
        }
        
    </script>

</body>
</html>
